## Preface

This function is used to call each other's methods across platforms to achieve cross platform compatibility.

## link
* <a href="#1">How to apply for a test account?</a>
* <a href="#2">How to get the exchange rate?</a>
* <a href="#3">How to call payment?</a>
* <a href="#4">How to view reports?</a>

## Function

- [x] Acquire device terminal system
- [x] Ajax encapsulation
- [x] Cross platform

## Script description and presentation
  
  First, Introduce "./js/common.js" public script.
  ```html
    <script src="./js/common.js"></script>
  ```

  Second, initialize data to obtain current equipment and current exchange rate.
  ```JavaScript
    // common.js
    initialize: function() {
        window.terminal = this.getTerminal()
        this.ajax({
            url:"https://api.gmc-core.com/data/v3/api/gmc",
            type:"get",
            data: {
                to: "CMY"
            },
            dataType: "json",
            timeout: 10000,
            contentType: "application/json",
            success: function(data) {
                let res = JSON.parse(data)
                if (res.status == 1 && res.data) {
                    document.getElementById("rmb").innerHTML = res.data
                    document.getElementById("pay_rmb").innerHTML = res.data
                }
            },
            error: function(e) {
                console.log(e)
            }
        })
    }
  ```

  ```JavaScript
    // index.js
    app.initialize()
    app.certificationAddress()
  ```

  Third, get the order number generated by the server.
  ```JavaScript
    // index.js
    let Num = "";
    for(var i=0;i<6;i++) {
        Num += Math.floor(Math.random()*10);
    }
    let orderid = new Date().getTime() + Num  // This order number is generated by the server and returned to the client
  ```

  Fourth, H5 cross platform(IOS/Andriod) bridge.
  #### <a name="3">How to call payment?</a>
  ```JavaScript
    // index.js
    let params = {
        order_id: "202005180029", // Generated and returned by the server
        gmc_num: gmcNUm,
        address: "gmc59265e7673c997089e74ffedfgrw00e954787jkh" // Receiving address
    }
    if (terminal == "ios") {
        app.setupWebViewJavascriptBridge(function(bridge) {
            payBtn.onclick = function (e) {
                bridge.callHandler("payAction", params, callback(response) {
                    payForCallbackIos(response)
                })
            }
        })
    } else {
        payBtn.onclick = function (e) {
            let paramStr = JSON.stringify(params)
            android.payAction(paramStr) // After Android processes the payment interface, it will directly call the payForCallback function, which needs to be placed in the index.html payForCallback is declared on the file. The callback function will return the payment status after.
        }
    }
  ```
  ```JavaScript
    /**
    * @function payForCallback
    * @param {message: '', status: 1} res  // status: 0 --> fail, 1 --> success
    */
    function payForCallback(res) {
        alert(res)
        // To do something ..
    }
  ```

  Finally, after the cross platform call, get the return value from the callback function and handle the callback event.  

## API
  1. <a name="1">Apply for mall test accoun</a>
     ```Java
     /** 
     * address: Merchant authentication address
     */
     Get Request
     https://api.gmc-core.com/qdapps/v3/api/storePay/testAccount/{address}
     
     Response
     {
         "status": "1",
         "message": "SECCESS",
         "data": "0gmcgmc3392c77107e58fb999d0afc6654587910c7a7a5b", // Test account number
         "timestamp": "12/08/2020 01:39:08447"
     }
     ```
  2. <a name="2">Get GMC Price</a>
     ```Java
     Get Request
     https://api.gmc-core.com/data/v3/api/gmc

     Response
         {
            "status": "1",
            "message": "SECCESS",
            "data": 1.388,
            "timestamp": "16/07/2020 08:44:01262"
        }
     ```
  3. Order Status Query
     ```Java
     /**
     * orderId: Order number 
     * address: Merchant authentication address
     */
     Get Request
     https://api.gmc-core.com/data/v3/api/storePay/{orderId}?address=
     
     Response
     {
         "status": "1",
         "message": "SECCESS",
         "data": {
             "status": 1 // 1 Unpaid,  200 SUCCESS
         },
         "timestamp": "08/07/2020 08:20:59679"
     }
     ```
  4. <a name="4">Account Details Query</a>
     ```Java
     /**
      * address: Merchant authentication address
      */
     Get Request
     https://api.gmc-core.com/data/v3/api/storePay/fundLog/{address}
     
     Response
     {
         "status": "1",
         "message": "SECCESS",
         "data": [
             {
                 "orderId": "6", // Order Number
                 "status": 8, // 1 Account not received, 8 Received account
                 "ptype": "GMC" // Coin type
             },
            ...
         ],
         "timestamp": "10/07/2020 06:14:27518"
     }
     ```
  

## Notice

  1.Ajax cross domain problem.

  2.Cross platform agreement.



## 前言

此方法用于跨平台之间的相互通讯和相互调用，以实现跨平台之间的兼容性。

## link
* <a href="#5">如何申请测试账号？</a>
* <a href="#6">如何获取汇率？</a>
* <a href="#7">如何调用支付？</a>
* <a href="#8">如何查看报表？</a>

## 功能函数

- [x] 获取移动终端信息
- [x] Ajax请求
- [x] 跨平台桥接

## 脚本使用演示
  第一步：引入功能函数文件
  ```html
    <script src="./js/common.js"></script>
  ```

  第二步：调用初始化方法，获取移动终端信息和获取当前汇率，以及调用申请商城测试账号API
  ```JavaScript
    // common.js
    initialize: function() {
        window.terminal = this.getTerminal()
        this.ajax({
            url:"https://api.gmc-core.com/data/v3/api/gmc",
            type:"get",
            data: {
                to: "CMY"
            },
            dataType: "json",
            timeout: 10000,
            contentType: "application/json",
            success: function(data) {
                let res = JSON.parse(data)
                if (res.status == 1 && res.data) {
                    document.getElementById("rmb").innerHTML = res.data
                    document.getElementById("pay_rmb").innerHTML = res.data
                }
            },
            error: function(e) {
                console.log(e)
            }
        })
    }
  ```
  ```JavaScript
    // index.js
    app.initialize()
  ```

  第三步：调用服务端生成订单号API。
  ```JavaScript
    // index.js
    let Num = "";
    for(var i=0;i<6;i++) {
        Num += Math.floor(Math.random()*10);
    }
    let orderid = new Date().getTime() + Num  // 此订单号由服务端生成返回给客户端
  ```

  第四步：H5跨平台（IOS/Andriod）。
  #### <a name="7">拉起支付</a>
  ```JavaScript
    // index.js
    let params = {
        order_id: "202005180029", // Generated and returned by the server
        gmc_num: gmcNUm,
        address: "gmc59265e7673c997089e74ffedfgrw00e954787jkh" // 收款地址
    }
    if (terminal == "ios") {
        app.setupWebViewJavascriptBridge(function(bridge) {
            payBtn.onclick = function (e) {
                bridge.callHandler("payAction", params, callback(response) {
                    payForCallbackIos(response)
                })
            }
        })
    } else {
        payBtn.onclick = function (e) {
            let paramStr = JSON.stringify(params)
            android.payAction(paramStr) // 安卓在处理完支付接口后，直接会调用payForCallback回调函数，此回调函数需放在index.html文件上声明payForCallback。该回调函数会返回支付后的支付状态等参数。
        }
    }
  ```
  ```JavaScript
    /**
    * @function payForCallback
    * @param {message: '', status: 1} res  // status: 0 --> fail, 1 --> success
    */
    function payForCallback(res) {
        alert(res)
        // To do something ..
    }
  ```

  最后，跨平台调用后，从回调函数中获取返回值并处理回调事件。

## API
  1. <a name="5">申请商城测试账号</a>
     ```Java
     /** 
     * address: Merchant authentication address
     */
     Get Request
     https://api.gmc-core.com/qdapps/v3/api/storePay/testAccount/{address}
     
     Response
     {
         "status": "1",
         "message": "SECCESS",
         "data": "0gmcgmc3392c77107e58fb999d0afc6654587910c7a7a5b", // 测试账号
         "timestamp": "12/08/2020 01:39:08447"
     }
     ```
  2. <a name="6">获取汇率</a>
     ```Java
     Get Request
     https://api.gmc-core.com/data/v3/api/gmc

     Response
         {
            "status": "1",
            "message": "SECCESS",
            "data": 1.388,
            "timestamp": "16/07/2020 08:44:01262"
        }
     ```
  3. 订单状态查询
     ```Java
     /**
     * orderId: Order number 
     * address: Merchant authentication address
     */
     Get Request
     https://api.gmc-core.com/data/v3/api/storePay/{orderId}?address=
     
     Response
     {
         "status": "1",
         "message": "SECCESS",
         "data": {
             "status": 1 // 1 Unpaid,  200 SUCCESS
         },
         "timestamp": "08/07/2020 08:20:59679"
     }
     ```
  4. <a name="8">交易详情</a>
     ```Java
     /**
      * address: Merchant authentication address
      */
     Get Request
     https://api.gmc-core.com/data/v3/api/storePay/fundLog/{address}
     
     Response
     {
         "status": "1",
         "message": "SECCESS",
         "data": [
             {
                 "orderId": "6", // Order Number
                 "status": 8, // 1 Account not received, 8 Received account
                 "ptype": "GMC" // Coin type
             },
            ...
         ],
         "timestamp": "10/07/2020 06:14:27518"
     }
     ```
  

## 注意事项
1. Ajax 跨域
2. 跨平台协议（h5端与终端约定协议，如：调用方法的方法名（payAction））
