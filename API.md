## Preface

This function is used to call each other's methods across platforms to achieve cross platform compatibility.

## link
* <a href="#1">How to apply for a test account?</a>
* <a href="#2">How to get the exchange rate?</a>
* <a href="#3">How to call payment?</a>
* <a href="#4">How to view reports?</a>
* <a href="#11">How to confirm order？</a>
* <a href="#12">How to refund order？</a>

## Function

- [x] Acquire device terminal system
- [x] Ajax encapsulation
- [x] Cross platform

## Script description and presentation
  
  First, Introduce "./js/common.js" public script.
  ```html
    <script src="./js/common.js"></script>
  ```

  Second, initialize data to obtain current equipment and current exchange rate.
  ```JavaScript
    // common.js
    initialize: function() {
        window.terminal = this.getTerminal()
        this.ajax({
            url:"https://api.gmc-core.com/data/v3/api/gmc",
            type:"get",
            data: {
                to: "CMY"
            },
            dataType: "json",
            timeout: 10000,
            contentType: "application/json",
            success: function(data) {
                let res = JSON.parse(data)
                if (res.status == 1 && res.data) {
                    document.getElementById("rmb").innerHTML = res.data
                    document.getElementById("pay_rmb").innerHTML = res.data
                }
            },
            error: function(e) {
                console.log(e)
            }
        })
    }
  ```

  ```JavaScript
    // index.js
    app.initialize()
    app.certificationAddress()
  ```

  Third, get the order number generated by the server.
  ```JavaScript
    // index.js
    let Num = "";
    for(var i=0;i<6;i++) {
        Num += Math.floor(Math.random()*10);
    }
    let orderid = new Date().getTime() + Num  // This order number is generated by the server and returned to the client
  ```

  Fourth, H5 cross platform(IOS/Andriod) bridge.
  #### <a name="3">How to call payment?</a>
  ```JavaScript
    // index.js
    let params = {
        order_id: orderid, // Generated and returned by the server
        gmc_num: gmcNUm,
        address: "gmc59265e7673c997089e74ffedfgrw00e954787jkh" // Receiving address
    }
    if (terminal == "ios") {
        app.setupWebViewJavascriptBridge(function(bridge) {
            payBtn.onclick = function (e) {
                bridge.callHandler("payAction", params, callback(response) {
                    payForCallbackIos(response)
                })
            }
        })
    } else {
        payBtn.onclick = function (e) {
            let paramStr = JSON.stringify(params)
            android.payAction(paramStr) // After Android processes the payment interface, it will directly call the payForCallback function, which needs to be placed in the index.html payForCallback is declared on the file. The callback function will return the payment status after.
        }
    }
  ```
  ```JavaScript
    /**
    * @function payForCallback
    * @param {message: '', status: 1} res  
    * // status: {
    *       '0': 'Network Error',
    *       '1': 'Success',
    *       '2': 'The payment function of the mall is temporarily closed',
    *       '3': 'Wrong payment currency type of mall',
    *       '4': 'Wrong amount',
    *       '5': 'The mall is not a trusted address',
    *       '6': 'Repeat payment for order',
    *       '7': 'Payment account address does not exist',
    *       '8': 'Insufficient account balance'
    *    }
    */
    function payForCallback(res) {
        alert(res)
        // To do something ...
    }
  ```

  Finally, after the cross platform call, get the return value from the callback function and handle the callback event.  

## API
  1. <a name="1">Apply for mall test accoun</a>
     ```Java
     /** 
     * address: Merchant authentication address
     */
     Get Request
     https://api.gmc-core.com/qdapps/v3/api/storePay/testAccount/{address}
     
     Response
     {
         "status": "1",
         "message": "SECCESS",
         "data": "0gmcgmc3392c77107e58fb999d0afc6654587910c7a7a5b", // Test account number
         "timestamp": "12/08/2020 01:39:08447"
     }
     ```
  2. <a name="2">Get GMC Price</a>
     ```Java
     Get Request
     https://api.gmc-core.com/data/v3/api/gmc

     Response
         {
            "status": "1",
            "message": "SECCESS",
            "data": 1.388,
            "timestamp": "16/07/2020 08:44:01262"
        }
     ```
  3. Order Status Query
     ```Java
     /**
     * orderId: Order number 
     * address: Merchant authentication address
     */
     Get Request
     https://api.gmc-core.com/data/v3/api/storePay/{orderId}?address=
     
     Response
     {
         "status": "1",
         "message": "SECCESS",
         "data": {
             "status": 1 // 1 Unpaid,  200 SUCCESS 9 Refund
         },
         "timestamp": "08/07/2020 08:20:59679"
     }
     ```
  4. <a name="4">Account Details Query</a>
     ```Java
     /**
      * address: Merchant authentication address
      */
     Get Request
     https://api.gmc-core.com/data/v3/api/storePay/fundLog/{address}
     
     Response
     {
         "status": "1",
         "message": "SECCESS",
         "data": [
             {
                 "orderId": "6", // Order Number
                 "status": 8, // 1 Account not received, 8 Received account 9 Refund
                 "ptype": "GMC" // Coin type
             },
            ...
         ],
         "timestamp": "10/07/2020 06:14:27518"
     }
     ```

     5. <a name="11">Order Confirm</a>
     ```Java
     /**
      * address: Merchant authentication address
      */
     Post Request
     https://api.gmc-core.com/order/v3/api/{key}/storePay/confirm

     {
        "data":"Dt5uLnLH5+gMMdePol7imYKbxAelexJLOOzAFoN5hiQGYWcmNV+eG5jCBxx7IoHZN01Hgr53+D6oofH+3FwejiA5HwzNVKJllO9BsZz7WHmApIQ8qvt7cXopS6U5gWDWwrVcK/ORWvKXJtJkM0dSf+aIVD6rHPm1FGoj7XQ0ogo="
     }

    
        //The encrypted public key and {key} needs to be applied for.Be sure to keep these two information confidential. If it is leaked, the consequences will be borne by yourself. The value of data is the returned string of JSON encrypted by RSA asymmetric algorithm. The following is a pseudo code example.
        JSONObject data = new JSONObject();
        data.put("orderId", "11111"); //orderId
        data.put("address", "gmcd85da0d9e23650719757e83cf858e4209cd65139");  //address
        String jsonString = RSAPublicKeySecurity.publicEncrypt(data.toJSONString(),pubblicKey);
     
     Response
     {
        "status": "1",
        "message": "SUCCESS",
        "data": {
            "orderId": "16003452114327",
            "message": "没有对应的订单ID！",
            "status": 0 // 0 No Order Message 1 Order Confirm Success
        },
        "timestamp": "17/10/2020 02:55:18056"
     }
     ```

  6. <a name="12">Order Refund</a>
     ```Java
     /**
      * address: Merchant authentication address
      */
     Post Request
     https://api.gmc-core.com/order/v3/api/{key}/storePay/refund
        {
            "data":"Dt5uLnLH5+gMMdePol7imYKbxAelexJLOOzAFoN5hiQGYWcmNV+eG5jCBxx7IoHZN01Hgr53+D6oofH+3FwejiA5HwzNVKJllO9BsZz7WHmApIQ8qvt7cXopS6U5gWDWwrVcK/ORWvKXJtJkM0dSf+aIVD6rHPm1FGoj7XQ0ogo="
        }

        //The encrypted public key and {key} needs to be applied for.Be sure to keep these two information confidential. If it is leaked, the consequences will be borne by yourself. The value of data is the returned string of JSON encrypted by RSA asymmetric algorithm. The following is a pseudo code example.
        JSONObject data = new JSONObject();
        data.put("orderId", "11111"); //orderId
        data.put("address", "gmcd85da0d9e23650719757e83cf858e4209cd65139");  //address
        String jsonString = RSAPublicKeySecurity.publicEncrypt(data.toJSONString(),pubblicKey);
     
     Response
     {
        "status": "1",
        "message": "SECCESS",
        "data": {
            "orderId": "16003452114327",
            "message": "没有对应的订单ID！",
            "status": 0 // 0 No Order Message 1 Order Completed 9 Order Refund Success

        },
        "timestamp": "17/10/2020 02:55:18056"
     }
     ```
  

## Notice

  1.Ajax cross domain problem.

  2.Cross platform agreement.



## 前言

此方法用于跨平台之间的相互通讯和相互调用，以实现跨平台之间的兼容性。

## link
* <a href="#5">如何申请测试账号？</a>
* <a href="#6">如何获取汇率？</a>
* <a href="#7">如何调用支付？</a>
* <a href="#8">如何查看报表？</a>
* <a href="#9">如何确认收货？</a>
* <a href="#10">如何申请退款？</a>

## 功能函数

- [x] 获取移动终端信息
- [x] Ajax请求
- [x] 跨平台桥接

## 脚本使用演示
  第一步：引入功能函数文件
  ```html
    <script src="./js/common.js"></script>
  ```

  第二步：调用初始化方法，获取移动终端信息和获取当前汇率，以及调用申请商城测试账号API
  ```JavaScript
    // common.js
    initialize: function() {
        window.terminal = this.getTerminal()
        this.ajax({
            url:"https://api.gmc-core.com/data/v3/api/gmc",
            type:"get",
            data: {
                to: "CMY"
            },
            dataType: "json",
            timeout: 10000,
            contentType: "application/json",
            success: function(data) {
                let res = JSON.parse(data)
                if (res.status == 1 && res.data) {
                    document.getElementById("rmb").innerHTML = res.data
                    document.getElementById("pay_rmb").innerHTML = res.data
                }
            },
            error: function(e) {
                console.log(e)
            }
        })
    }
  ```
  ```JavaScript
    // index.js
    app.initialize()
  ```

  第三步：调用服务端生成订单号API。
  ```JavaScript
    // index.js
    let Num = "";
    for(var i=0;i<6;i++) {
        Num += Math.floor(Math.random()*10);
    }
    let orderid = new Date().getTime() + Num  // 此订单号由服务端生成返回给客户端
  ```

  第四步：H5跨平台（IOS/Andriod）。
  #### <a name="7">拉起支付</a>
  ```JavaScript
    // index.js
    let params = {
        order_id: orderid, // Generated and returned by the server
        gmc_num: gmcNUm,
        address: "gmc59265e7673c997089e74ffedfgrw00e954787jkh" // 收款地址
    }
    if (terminal == "ios") {
        app.setupWebViewJavascriptBridge(function(bridge) {
            payBtn.onclick = function (e) {
                bridge.callHandler("payAction", params, callback(response) {
                    payForCallbackIos(response)
                })
            }
        })
    } else {
        payBtn.onclick = function (e) {
            let paramStr = JSON.stringify(params)
            android.payAction(paramStr) // 安卓在处理完支付接口后，直接会调用payForCallback回调函数，此回调函数需放在index.html文件上声明payForCallback。该回调函数会返回支付后的支付状态等参数。
        }
    }
  ```
  ```JavaScript
    /**
    * @function payForCallback
    * @param {message: '', status: 1} res  
    * // status: {
    *       '0': '网络异常',
    *       '1': '支付成功',
    *       '2': '商城支付功能暂时不开放',
    *       '3': '商城支付货币类型错误',
    *       '4': '金额有误',
    *       '5': '商城不是可信任的地址',
    *       '6': '订单重复支付',
    *       '7': '支付账户地址不存在',
    *       '8': '账户余额不足'  
    *    }
    */
    function payForCallback(res) {
        alert(res)
        // To do something ...
    }
  ```

  最后，跨平台调用后，从回调函数中获取返回值并处理回调事件。

## API
  1. <a name="5">申请商城测试账号</a>
     ```Java
     /** 
     * address: Merchant authentication address
     */
     Get Request
     https://api.gmc-core.com/qdapps/v3/api/storePay/testAccount/{address}
     
     Response
     {
         "status": "1",
         "message": "SECCESS",
         "data": "0gmcgmc3392c77107e58fb999d0afc6654587910c7a7a5b", // 测试账号
         "timestamp": "12/08/2020 01:39:08447"
     }
     ```
  2. <a name="6">获取汇率</a>
     ```Java
     Get Request
     https://api.gmc-core.com/data/v3/api/gmc

     Response
         {
            "status": "1",
            "message": "SECCESS",
            "data": 1.388,
            "timestamp": "16/07/2020 08:44:01262"
        }
     ```
  3. 订单状态查询
     ```Java
     /**
     * orderId: Order number 
     * address: Merchant authentication address
     */
     Get Request
     https://api.gmc-core.com/data/v3/api/storePay/{orderId}?address=
     
     Response
     {
         "status": "1",
         "message": "SECCESS",
         "data": {
             "status": 1 // 1 Unpaid,  200 SUCCESS 9 Refund
         },
         "timestamp": "08/07/2020 08:20:59679"
     }
     ```
  4. <a name="8">交易详情</a>
     ```Java
     /**
      * address: Merchant authentication address
      */
     Get Request
     https://api.gmc-core.com/data/v3/api/storePay/fundLog/{address}
     
     Response
     {
         "status": "1",
         "message": "SECCESS",
         "data": [
             {
                 "orderId": "6", // Order Number
                 "status": 8, // 1 Account not received, 8 Received account 9 Refund
                 "ptype": "GMC" // Coin type
             },
            ...
         ],
         "timestamp": "10/07/2020 06:14:27518"
     }
     ```

  5. <a name="9">订单确认收货</a>
     ```Java
     /**
      * address: Merchant authentication address
      */
     Post Request
     https://api.gmc-core.com/order/v3/api/{key}/storePay/confirm

     {
        "data":"Dt5uLnLH5+gMMdePol7imYKbxAelexJLOOzAFoN5hiQGYWcmNV+eG5jCBxx7IoHZN01Hgr53+D6oofH+3FwejiA5HwzNVKJllO9BsZz7WHmApIQ8qvt7cXopS6U5gWDWwrVcK/ORWvKXJtJkM0dSf+aIVD6rHPm1FGoj7XQ0ogo="
     }

    
        //其中加密的公钥需要申请，请求路径的{key}也需要申请，务必要保密好这两个信息，如果泄露，后果自负。data的值是RSA非对称算法加密的json返回字符串，下面是一个伪代码示例：
        JSONObject data = new JSONObject();
        data.put("orderId", "11111"); //orderId
        data.put("address", "gmcd85da0d9e23650719757e83cf858e4209cd65139");  //address
        String jsonString = RSAPublicKeySecurity.publicEncrypt(data.toJSONString(),pubblicKey);
     
     Response
     {
        "status": "1",
        "message": "SECCESS",
        "data": {
            "orderId": "16003452114327",
            "message": "没有对应的订单ID！",
            "status": 0 // 0 没有对应的订单 1 订单确认收货成功
        },
        "timestamp": "17/10/2020 02:55:18056"
     }
     ```

  6. <a name="10">订单申请退款</a>
     ```Java
     /**
      * address: Merchant authentication address
      */
     Post Request
     https://api.gmc-core.com/order/v3/api/{key}/storePay/refund
        {
            "data":"Dt5uLnLH5+gMMdePol7imYKbxAelexJLOOzAFoN5hiQGYWcmNV+eG5jCBxx7IoHZN01Hgr53+D6oofH+3FwejiA5HwzNVKJllO9BsZz7WHmApIQ8qvt7cXopS6U5gWDWwrVcK/ORWvKXJtJkM0dSf+aIVD6rHPm1FGoj7XQ0ogo="
        }

        //其中加密的公钥需要申请，请求路径的{key}也需要申请，务必要保密好这两个信息，如果泄露，后果自负。data的值是RSA非对称算法加密的json返回字符串，下面是一个伪代码示例：
        JSONObject data = new JSONObject();
        data.put("orderId", "11111"); //orderId
        data.put("address", "gmcd85da0d9e23650719757e83cf858e4209cd65139");  //address
        String jsonString = RSAPublicKeySecurity.publicEncrypt(data.toJSONString(),pubblicKey);
     
     Response
     {
        "status": "1",
        "message": "SECCESS",
        "data": {
            "orderId": "16003452114327",
            "message": "没有对应的订单ID！",
            "status": 0 // 0 没有对应的订单 1 订单确认收货成功
        },
        "timestamp": "17/10/2020 02:55:18056"
     }
     ```
  

## 注意事项
1. Ajax 跨域
2. 跨平台协议（h5端与终端约定协议，如：调用方法的方法名（payAction））
